<!DOCTYPE html>
<html lang="ja">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
Â  Â  <title>éŸ³ã®å‘¨æ³¢æ•°ãƒ»æ³¢å½¢ã‚¢ãƒŠãƒ©ã‚¤ã‚¶ (æ“ä½œæ”¹å–„ç‰ˆ)</title>
Â  Â  <style>
Â  Â  Â  Â  /* --- åŸºæœ¬è¨­å®š --- */
Â  Â  Â  Â  body {Â 
Â  Â  Â  Â  Â  Â  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;Â 
Â  Â  Â  Â  Â  Â  text-align: center;Â 
Â  Â  Â  Â  Â  Â  color: #333;Â 
Â  Â  Â  Â  Â  Â  margin: 0;
Â  Â  Â  Â  Â  Â  padding: 10px;
Â  Â  Â  Â  Â  Â  padding-bottom: 140px; /* ã‚¹ãƒãƒ›ã§ãƒœã‚¿ãƒ³ãŒè¢«ã‚‰ãªã„ã‚ˆã†ã«ä¸‹éƒ¨ã«ä½™ç™½ */
Â  Â  Â  Â  Â  Â  background-color: #f4f4f4;
Â  Â  Â  Â  }

Â  Â  Â  Â  h1 { font-size: 1.2rem; margin: 5px 0; }
Â  Â  Â  Â  p { font-size: 0.8rem; color: #666; margin-bottom: 10px; }

Â  Â  Â  Â  /* --- æ“ä½œãƒ‘ãƒãƒ« (PC/ã‚¹ãƒãƒ›å…±é€šãƒ™ãƒ¼ã‚¹) --- */
Â  Â  Â  Â  .controls {Â 
Â  Â  Â  Â  Â  Â  background-color: #fff;
Â  Â  Â  Â  Â  Â  padding: 10px;
Â  Â  Â  Â  Â  Â  border-radius: 12px;
Â  Â  Â  Â  Â  Â  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
Â  Â  Â  Â  Â  Â  margin-bottom: 15px;
Â  Â  Â  Â  Â  Â  display: inline-block;
Â  Â  Â  Â  Â  Â  max-width: 100%;
Â  Â  Â  Â  Â  Â  z-index: 1000;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* --- ãƒœã‚¿ãƒ³å…±é€šã‚¹ã‚¿ã‚¤ãƒ« --- */
Â  Â  Â  Â  button {
Â  Â  Â  Â  Â  Â  padding: 10px 14px;
Â  Â  Â  Â  Â  Â  font-size: 0.9rem;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  margin: 4px;
Â  Â  Â  Â  Â  Â  border: 1px solid #ccc;
Â  Â  Â  Â  Â  Â  border-radius: 6px;
Â  Â  Â  Â  Â  Â  background-color: #fff;
Â  Â  Â  Â  Â  Â  touch-action: manipulation;
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  Â  Â  transition: transform 0.1s;
Â  Â  Â  Â  }
Â  Â  Â  Â  button:active { transform: scale(0.95); }
Â  Â  Â  Â  button:disabled { color: #ccc; border-color: #eee; background-color: #fafafa; }

Â  Â  Â  Â  /* Start/Stop/Clear */
Â  Â  Â  Â  #startButton { background-color: #e3f2fd; border-color: #2196f3; color: #0d47a1; }
Â  Â  Â  Â  #stopButton { background-color: #ffebee; border-color: #ef5350; color: #c62828; }
Â  Â  Â  Â  #clearAllBtn { font-size: 0.8rem; padding: 10px 8px; }

Â  Â  Â  Â  /* ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆãƒœã‚¿ãƒ³ (è‰²åˆ†ã‘) */
Â  Â  Â  Â  .btn-snap-1 { border-color: #ef9a9a; color: #d32f2f; background: #fff; }
Â  Â  Â  Â  .btn-snap-1.active { background-color: #d32f2f; color: white; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .btn-snap-2 { border-color: #90caf9; color: #1976d2; background: #fff; }
Â  Â  Â  Â  .btn-snap-2.active { background-color: #1976d2; color: white; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .btn-snap-3 { border-color: #ffcc80; color: #f57c00; background: #fff; }
Â  Â  Â  Â  .btn-snap-3.active { background-color: #f57c00; color: white; }

Â  Â  Â  Â  /* --- çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ --- */
Â  Â  Â  Â  #result {Â 
Â  Â  Â  Â  Â  Â  margin: 0 auto 15px;Â 
Â  Â  Â  Â  Â  Â  padding: 10px;
Â  Â  Â  Â  Â  Â  background: #fff;
Â  Â  Â  Â  Â  Â  display: table;
Â  Â  Â  Â  Â  Â  border-radius: 8px;
Â  Â  Â  Â  Â  Â  font-size: 1rem;Â 
Â  Â  Â  Â  Â  Â  font-weight: bold;Â 
Â  Â  Â  Â  Â  Â  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
Â  Â  Â  Â  }

Â  Â  Â  Â  /* --- ã‚°ãƒ©ãƒ•ã‚³ãƒ³ãƒ†ãƒŠ --- */
Â  Â  Â  Â  .graph-container {Â 
Â  Â  Â  Â  Â  Â  display: flex;Â 
Â  Â  Â  Â  Â  Â  flex-wrap: wrap;Â 
Â  Â  Â  Â  Â  Â  justify-content: center;Â 
Â  Â  Â  Â  Â  Â  gap: 15px;Â 
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  }

Â  Â  Â  Â  .graph-box {
Â  Â  Â  Â  Â  Â  flex: 1 1 500px;
Â  Â  Â  Â  Â  Â  max-width: 100%;
Â  Â  Â  Â  Â  Â  background: #fff;
Â  Â  Â  Â  Â  Â  padding: 5px;
Â  Â  Â  Â  Â  Â  border-radius: 8px;
Â  Â  Â  Â  Â  Â  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
Â  Â  Â  Â  Â  Â  box-sizing: border-box;
Â  Â  Â  Â  }

Â  Â  Â  Â  h2 { font-size: 0.9rem; margin: 5px 0; color: #555; }

Â  Â  Â  Â  canvas {
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  height: auto;
Â  Â  Â  Â  Â  Â  display: block;
Â  Â  Â  Â  Â  Â  border: 1px solid #eee;
Â  Â  Â  Â  Â  Â  background-color: #fafafa;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* --- ğŸ“± ã‚¹ãƒãƒ›ç”¨ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–è¨­å®š (å¹…768pxä»¥ä¸‹) --- */
Â  Â  Â  Â  @media (max-width: 768px) {
Â  Â  Â  Â  Â  Â  /* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã‚’ç”»é¢ä¸‹ã«å›ºå®š */
Â  Â  Â  Â  Â  Â  .controls {
Â  Â  Â  Â  Â  Â  Â  Â  position: fixed;
Â  Â  Â  Â  Â  Â  Â  Â  bottom: 0;
Â  Â  Â  Â  Â  Â  Â  Â  left: 0;
Â  Â  Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  Â  Â  margin: 0;
Â  Â  Â  Â  Â  Â  Â  Â  padding: 8px 5px;
Â  Â  Â  Â  Â  Â  Â  Â  border-radius: 15px 15px 0 0; /* ä¸Šã®è§’ã ã‘ä¸¸ã */
Â  Â  Â  Â  Â  Â  Â  Â  box-shadow: 0 -4px 10px rgba(0,0,0,0.1);
Â  Â  Â  Â  Â  Â  Â  Â  box-sizing: border-box;
Â  Â  Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  Â  Â  flex-direction: column; /* ä¸Šä¸‹ã«åˆ†ã‘ã‚‹ */
Â  Â  Â  Â  Â  Â  Â  Â  gap: 5px;
Â  Â  Â  Â  Â  Â  Â  Â  background-color: rgba(255, 255, 255, 0.95);
Â  Â  Â  Â  Â  Â  Â  Â  backdrop-filter: blur(5px);
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  /* ãƒœã‚¿ãƒ³ã®ä¸¦ã³ã‚’èª¿æ•´ */
Â  Â  Â  Â  Â  Â  .ctrl-row {
Â  Â  Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  Â  Â  Â  Â  gap: 5px;
Â  Â  Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  /* ãƒœã‚¿ãƒ³ã‚µã‚¤ã‚ºèª¿æ•´ */
Â  Â  Â  Â  Â  Â  button {
Â  Â  Â  Â  Â  Â  Â  Â  flex: 1; /* æ¨ªå¹…ã„ã£ã±ã„ã«åºƒã’ã‚‹ */
Â  Â  Â  Â  Â  Â  Â  Â  margin: 0;
Â  Â  Â  Â  Â  Â  Â  Â  padding: 12px 0; /* ã‚¿ãƒƒãƒ—ã—ã‚„ã™ã„é«˜ã• */
Â  Â  Â  Â  Â  Â  Â  Â  font-size: 0.85rem;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  /* ãƒ†ã‚­ã‚¹ãƒˆãŒé•·ã™ãã‚‹ã¨æº¢ã‚Œã‚‹ã®ã§çŸ­ç¸®è¡¨è¨˜ãªã©æ¤œè¨ */
Â  Â  Â  Â  Â  Â  .btn-snap-1, .btn-snap-2, .btn-snap-3 {
Â  Â  Â  Â  Â  Â  Â  Â  font-size: 1rem; /* æ•°å­—ã‚’è¦‹ã‚„ã™ã */
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  /* ã‚°ãƒ©ãƒ•ã®ãƒãƒ¼ã‚¸ãƒ³èª¿æ•´ */
Â  Â  Â  Â  Â  Â  .graph-box { margin-bottom: 10px; }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  /* ã‚¿ã‚¤ãƒˆãƒ«ã®èª¿æ•´ */
Â  Â  Â  Â  Â  Â  h1 { font-size: 1rem; }
Â  Â  Â  Â  }
Â  Â  </style>
</head>
<body>
Â  Â  <h1>ğŸ¤ éŸ³ã®æ³¢å½¢ãƒ»å‘¨æ³¢æ•°ã‚¢ãƒŠãƒ©ã‚¤ã‚¶</h1>
Â  Â  <div id="result">
Â  Â  Â  Â  å‘¨æ³¢æ•°: --- Hz / éŸ³ç¨‹: ---
Â  Â  </div>

Â  Â  <div class="graph-container">
Â  Â  Â  Â  <div class="graph-box">
Â  Â  Â  Â  Â  Â  <h2>1. æ™‚é–“æ³¢å½¢ (ã‚ªã‚·ãƒ­ã‚¹ã‚³ãƒ¼ãƒ—)</h2>
Â  Â  Â  Â  Â  Â  <canvas id="timeGraph"></canvas>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="graph-box">
Â  Â  Â  Â  Â  Â  <h2>2. å‘¨æ³¢æ•°ã‚¹ãƒšã‚¯ãƒˆãƒ« (FFT)</h2>
Â  Â  Â  Â  Â  Â  <canvas id="freqGraph"></canvas>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div class="controls">
Â  Â  Â  Â  <div class="ctrl-row">
Â  Â  Â  Â  Â  Â  <button id="startButton">â–¶ é–‹å§‹</button>
Â  Â  Â  Â  Â  Â  <button id="stopButton" disabled>â–  åœæ­¢</button>
Â  Â  Â  Â  Â  Â  <button id="clearAllBtn" disabled>ã‚¯ãƒªã‚¢</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="ctrl-row">
Â  Â  Â  Â  Â  Â  <button id="snapBtn1" class="btn-snap-1" disabled>â‘  èµ¤</button>
Â  Â  Â  Â  Â  Â  <button id="snapBtn2" class="btn-snap-2" disabled>â‘¡ é’</button>
Â  Â  Â  Â  Â  Â  <button id="snapBtn3" class="btn-snap-3" disabled>â‘¢ æ©™</button>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <script>
Â  Â  Â  Â  // --- ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° ---
Â  Â  Â  Â  let audioContext;
Â  Â  Â  Â  let analyser;
Â  Â  Â  Â  let source;
Â  Â  Â  Â  let rafId;Â 
Â  Â  Â  Â Â 
Â  Â  Â  Â  let freqDataArray;Â 
Â  Â  Â  Â  let timeDataArray;Â 
Â  Â  Â  Â  let currentDetectedFreq = 0;Â 

Â  Â  Â  Â  // ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆãƒ‡ãƒ¼ã‚¿
Â  Â  Â  Â  const snapshots = [
Â  Â  Â  Â  Â  Â  { freq: null, time: null, active: false, color: 'rgba(255, 0, 0, 0.8)' },
Â  Â  Â  Â  Â  Â  { freq: null, time: null, active: false, color: 'rgba(0, 0, 255, 0.7)' },
Â  Â  Â  Â  Â  Â  { freq: null, time: null, active: false, color: 'rgba(255, 140, 0, 0.8)' }
Â  Â  Â  Â  ];

Â  Â  Â  Â  // UIè¦ç´ 
Â  Â  Â  Â  const canvasElems = {
Â  Â  Â  Â  Â  Â  freq: document.getElementById('freqGraph'),
Â  Â  Â  Â  Â  Â  time: document.getElementById('timeGraph')
Â  Â  Â  Â  };
Â  Â  Â  Â  const canvasCtxs = {
Â  Â  Â  Â  Â  Â  freq: canvasElems.freq.getContext('2d'),
Â  Â  Â  Â  Â  Â  time: canvasElems.time.getContext('2d')
Â  Â  Â  Â  };
Â  Â  Â  Â  const resultDiv = document.getElementById('result');
Â  Â  Â  Â  const buttons = {
Â  Â  Â  Â  Â  Â  start: document.getElementById('startButton'),
Â  Â  Â  Â  Â  Â  stop: document.getElementById('stopButton'),
Â  Â  Â  Â  Â  Â  snaps: [
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('snapBtn1'),
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('snapBtn2'),
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('snapBtn3')
Â  Â  Â  Â  Â  Â  ],
Â  Â  Â  Â  Â  Â  clear: document.getElementById('clearAllBtn')
Â  Â  Â  Â  };

Â  Â  Â  Â  // å®šæ•°
Â  Â  Â  Â  const A4_FREQ = 440;
Â  Â  Â  Â  const HALF_STEP = Math.pow(2, 1/12);Â 
Â  Â  Â  Â  const NOTE_NAMES_INTL = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
Â  Â  Â  Â  const NOTE_NAMES_JAPANESE = ["ãƒ‰", "ãƒ‰#", "ãƒ¬", "ãƒ¬#", "ãƒŸ", "ãƒ•ã‚¡", "ãƒ•ã‚¡#", "ã‚½", "ã‚½#", "ãƒ©", "ãƒ©#", "ã‚·"];
Â  Â  Â  Â  const MIN_FREQ_DISPLAY = 20;Â 
Â  Â  Â  Â  const MAX_FREQ_DISPLAY = 8000;Â 
Â  Â  Â  Â  const TICK_FREQS = [20, 50, 100, 200, 400, 800, 1600, 3200, 6400];

Â  Â  Â  Â  // --- åˆæœŸåŒ– ---
Â  Â  Â  Â  window.addEventListener('resize', resizeCanvas);
Â  Â  Â  Â  resizeCanvas();

Â  Â  Â  Â  buttons.start.onclick = startAnalysis;
Â  Â  Â  Â  buttons.stop.onclick = stopAnalysis;
Â  Â  Â  Â  buttons.clear.onclick = clearAllSnapshots;

Â  Â  Â  Â  buttons.snaps.forEach((btn, index) => {
Â  Â  Â  Â  Â  Â  btn.onclick = () => toggleSnapshot(index);
Â  Â  Â  Â  });

Â  Â  Â  Â  // --- Canvasãƒªã‚µã‚¤ã‚ºå‡¦ç† ---
Â  Â  Â  Â  function resizeCanvas() {
Â  Â  Â  Â  Â  Â  const boxes = document.querySelectorAll('.graph-box');
Â  Â  Â  Â  Â  Â  if (boxes.length === 0) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const boxWidth = boxes[0].clientWidth;
Â  Â  Â  Â  Â  Â  // æ¯”ç‡è¨­å®š (ã‚¹ãƒãƒ›ç¸¦ãªã‚‰å°‘ã—é«˜ã•ã‚’å‡ºã™)
Â  Â  Â  Â  Â  Â  const isMobile = window.innerWidth < 600;
Â  Â  Â  Â  Â  Â  const newWidth = boxWidth - 10;Â 
Â  Â  Â  Â  Â  Â  const newHeight = isMobile ? newWidth * 0.6 : newWidth * 0.45;

Â  Â  Â  Â  Â  Â  const finalWidth = Math.max(newWidth, 300);
Â  Â  Â  Â  Â  Â  const finalHeight = Math.max(newHeight, 180);

Â  Â  Â  Â  Â  Â  // ä¸¡æ–¹ã®ã‚­ãƒ£ãƒ³ãƒã‚¹ã«é©ç”¨
Â  Â  Â  Â  Â  Â  for (let key in canvasElems) {
Â  Â  Â  Â  Â  Â  Â  Â  canvasElems[key].width = finalWidth;
Â  Â  Â  Â  Â  Â  Â  Â  canvasElems[key].height = finalHeight;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if (!rafId && (snapshots.some(s => s.active) || freqDataArray)) {
Â  Â  Â  Â  Â  Â  Â  Â  requestAnimationFrame(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  drawFrequencyGraph();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  drawTimeDomainGraph();
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- è§£æé–‹å§‹ ---
Â  Â  Â  Â  async function startAnalysis() {
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const AudioContext = window.AudioContext || window.webkitAudioContext;
Â  Â  Â  Â  Â  Â  Â  Â  if (!audioContext) audioContext = new AudioContext();
Â  Â  Â  Â  Â  Â  Â  Â  if (audioContext.state === 'suspended') await audioContext.resume();

Â  Â  Â  Â  Â  Â  Â  Â  const stream = await navigator.mediaDevices.getUserMedia({Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  audio: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  echoCancellation: false,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  noiseSuppression: false,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  autoGainControl: falseÂ 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }Â 
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  analyser = audioContext.createAnalyser();
Â  Â  Â  Â  Â  Â  Â  Â  source = audioContext.createMediaStreamSource(stream);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  analyser.fftSize = 2048;Â 
Â  Â  Â  Â  Â  Â  Â  Â  analyser.smoothingTimeConstant = 0.85;Â 

Â  Â  Â  Â  Â  Â  Â  Â  timeDataArray = new Uint8Array(analyser.fftSize);Â 
Â  Â  Â  Â  Â  Â  Â  Â  freqDataArray = new Uint8Array(analyser.frequencyBinCount);Â 
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  source.connect(analyser);

Â  Â  Â  Â  Â  Â  Â  Â  buttons.start.disabled = true;
Â  Â  Â  Â  Â  Â  Â  Â  buttons.stop.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  buttons.clear.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  buttons.snaps.forEach(btn => btn.disabled = false);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  draw();

Â  Â  Â  Â  Â  Â  } catch (err) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error(err);
Â  Â  Â  Â  Â  Â  Â  Â  alert('ãƒã‚¤ã‚¯ã®ã‚¢ã‚¯ã‚»ã‚¹ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- è§£æåœæ­¢ ---
Â  Â  Â  Â  function stopAnalysis() {
Â  Â  Â  Â  Â  Â  cancelAnimationFrame(rafId);
Â  Â  Â  Â  Â  Â  rafId = null;
Â  Â  Â  Â  Â  Â  if (source) {
Â  Â  Â  Â  Â  Â  Â  Â  source.disconnect();
Â  Â  Â  Â  Â  Â  Â  Â  source = null;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if (audioContext) audioContext.suspend();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  buttons.start.disabled = false;
Â  Â  Â  Â  Â  Â  buttons.stop.disabled = true;
Â  Â  Â  Â  Â  Â  buttons.clear.disabled = true;
Â  Â  Â  Â  Â  Â  buttons.snaps.forEach(btn => btn.disabled = true);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  currentDetectedFreq = 0;Â 
Â  Â  Â  Â  Â  Â  resultDiv.innerHTML = "å‘¨æ³¢æ•°: --- Hz / éŸ³ç¨‹: ---";
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆå‡¦ç† ---
Â  Â  Â  Â  function toggleSnapshot(index) {
Â  Â  Â  Â  Â  Â  const snap = snapshots[index];
Â  Â  Â  Â  Â  Â  const btn = buttons.snaps[index];

Â  Â  Â  Â  Â  Â  if (!snap.active) {
Â  Â  Â  Â  Â  Â  Â  Â  if (freqDataArray && timeDataArray) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  snap.freq = new Uint8Array(freqDataArray);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  snap.time = new Uint8Array(timeDataArray);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  snap.active = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  btn.classList.add('active');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  btn.textContent = `â‘ â‘¡â‘¢`[index] + " æ¶ˆå»"; // ã‚¹ãƒãƒ›å‘ã‘ã«çŸ­ã
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  snap.freq = null;
Â  Â  Â  Â  Â  Â  Â  Â  snap.time = null;
Â  Â  Â  Â  Â  Â  Â  Â  snap.active = false;
Â  Â  Â  Â  Â  Â  Â  Â  btn.classList.remove('active');
Â  Â  Â  Â  Â  Â  Â  Â  btn.textContent = `â‘ â‘¡â‘¢`[index] + ` ${['èµ¤','é’','æ©™'][index]}`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function clearAllSnapshots() {
Â  Â  Â  Â  Â  Â  snapshots.forEach((snap, index) => {
Â  Â  Â  Â  Â  Â  Â  Â  snap.freq = null;
Â  Â  Â  Â  Â  Â  Â  Â  snap.time = null;
Â  Â  Â  Â  Â  Â  Â  Â  snap.active = false;
Â  Â  Â  Â  Â  Â  Â  Â  const btn = buttons.snaps[index];
Â  Â  Â  Â  Â  Â  Â  Â  btn.classList.remove('active');
Â  Â  Â  Â  Â  Â  Â  Â  btn.textContent = `â‘ â‘¡â‘¢`[index] + ` ${['èµ¤','é’','æ©™'][index]}`;
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- æç”»ãƒ«ãƒ¼ãƒ— ---
Â  Â  Â  Â  function draw() {
Â  Â  Â  Â  Â  Â  rafId = requestAnimationFrame(draw);

Â  Â  Â  Â  Â  Â  if(analyser) {
Â  Â  Â  Â  Â  Â  Â  Â  analyser.getByteFrequencyData(freqDataArray);Â 
Â  Â  Â  Â  Â  Â  Â  Â  analyser.getByteTimeDomainData(timeDataArray);Â 
Â  Â  Â  Â  Â  Â  Â  Â  currentDetectedFreq = detectPitch(freqDataArray, audioContext.sampleRate, analyser.frequencyBinCount);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  drawFrequencyGraph();
Â  Â  Â  Â  Â  Â  drawTimeDomainGraph();Â 
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  displayResult(currentDetectedFreq);
Â  Â  Â  Â  }

Â  Â  Â  Â  function freqToX(freq, width) {
Â  Â  Â  Â  Â  Â  const clampedFreq = Math.max(freq, MIN_FREQ_DISPLAY);Â 
Â  Â  Â  Â  Â  Â  const logMin = Math.log10(MIN_FREQ_DISPLAY);
Â  Â  Â  Â  Â  Â  const logMax = Math.log10(MAX_FREQ_DISPLAY);
Â  Â  Â  Â  Â  Â  const logFreq = Math.log10(clampedFreq);
Â  Â  Â  Â  Â  Â  return (logFreq - logMin) / (logMax - logMin) * width;
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- 1. å‘¨æ³¢æ•°ã‚°ãƒ©ãƒ•æç”» ---
Â  Â  Â  Â  function drawFrequencyGraph() {
Â  Â  Â  Â  Â  Â  const ctx = canvasCtxs.freq;
Â  Â  Â  Â  Â  Â  const width = canvasElems.freq.width;
Â  Â  Â  Â  Â  Â  const height = canvasElems.freq.height;
Â  Â  Â  Â  Â  Â  const sampleRate = audioContext ? audioContext.sampleRate : 44100;
Â  Â  Â  Â  Â  Â  const fftSize = analyser ? analyser.fftSize : 2048;
Â  Â  Â  Â  Â  Â  const freqResolution = sampleRate / fftSize;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  ctx.fillStyle = '#fafafa';
Â  Â  Â  Â  Â  Â  ctx.fillRect(0, 0, width, height);

Â  Â  Â  Â  Â  Â  ctx.strokeStyle = '#eee';Â 
Â  Â  Â  Â  Â  Â  ctx.fillStyle = '#999';Â 
Â  Â  Â  Â  Â  Â  ctx.font = '10px sans-serif';
Â  Â  Â  Â  Â  Â  ctx.textAlign = 'center';
Â  Â  Â  Â  Â  Â  ctx.lineWidth = 1;

Â  Â  Â  Â  Â  Â  TICK_FREQS.forEach(f => {
Â  Â  Â  Â  Â  Â  Â  Â  const x = freqToX(f, width);
Â  Â  Â  Â  Â  Â  Â  Â  ctx.beginPath();
Â  Â  Â  Â  Â  Â  Â  Â  ctx.moveTo(x, 0);
Â  Â  Â  Â  Â  Â  Â  Â  ctx.lineTo(x, height);
Â  Â  Â  Â  Â  Â  Â  Â  ctx.stroke();
Â  Â  Â  Â  Â  Â  Â  Â  if (x > 15 && x < width - 15) ctx.fillText(`${f}`, x, height - 5);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!freqDataArray && !snapshots.some(s=>s.active)) return;

Â  Â  Â  Â  Â  Â  const binCount = analyser ? analyser.frequencyBinCount : 1024;
Â  Â  Â  Â  Â  Â  const startIndex = Math.floor(MIN_FREQ_DISPLAY / freqResolution);Â 
Â  Â  Â  Â  Â  Â  const maxBinToDisplay = Math.min(binCount, Math.ceil(MAX_FREQ_DISPLAY / freqResolution));

Â  Â  Â  Â  Â  Â  snapshots.forEach(snap => {
Â  Â  Â  Â  Â  Â  Â  Â  if (snap.active && snap.freq) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  drawSingleFreqLine(ctx, snap.freq, width, height, freqResolution, startIndex, maxBinToDisplay, snap.color, 2);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  if (analyser && rafId) {
Â  Â  Â  Â  Â  Â  Â  Â  drawSingleFreqLine(ctx, freqDataArray, width, height, freqResolution, startIndex, maxBinToDisplay, '#222', 2);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (currentDetectedFreq > MIN_FREQ_DISPLAY && currentDetectedFreq < MAX_FREQ_DISPLAY) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const detectedX = freqToX(currentDetectedFreq, width);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const detectedIndex = Math.round(currentDetectedFreq / freqResolution);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let detectedY = height;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(detectedIndex < freqDataArray.length) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  detectedY = height - (freqDataArray[detectedIndex] / 255 * height);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ctx.fillStyle = 'red';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ctx.beginPath();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ctx.arc(detectedX, detectedY, 6, 0, Math.PI * 2, false);Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ctx.fill();
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function drawSingleFreqLine(ctx, data, width, height, resolution, startIndex, maxIndex, color, lineWidth) {
Â  Â  Â  Â  Â  Â  ctx.lineWidth = lineWidth;
Â  Â  Â  Â  Â  Â  ctx.strokeStyle = color;
Â  Â  Â  Â  Â  Â  ctx.beginPath();
Â  Â  Â  Â  Â  Â  let hasStarted = false;
Â  Â  Â  Â  Â  Â  for (let i = startIndex; i < maxIndex; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  const x = freqToX(i * resolution, width);
Â  Â  Â  Â  Â  Â  Â  Â  const y = height - (data[i] / 255 * height);
Â  Â  Â  Â  Â  Â  Â  Â  if (!hasStarted) { ctx.moveTo(x, y); hasStarted = true; }Â 
Â  Â  Â  Â  Â  Â  Â  Â  else { ctx.lineTo(x, y); }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  ctx.stroke();
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- 2. æ™‚é–“æ³¢å½¢ã‚°ãƒ©ãƒ•æç”» ---
Â  Â  Â  Â  function drawTimeDomainGraph() {
Â  Â  Â  Â  Â  Â  const ctx = canvasCtxs.time;
Â  Â  Â  Â  Â  Â  const width = canvasElems.time.width;
Â  Â  Â  Â  Â  Â  const height = canvasElems.time.height;

Â  Â  Â  Â  Â  Â  ctx.fillStyle = '#fafafa';
Â  Â  Â  Â  Â  Â  ctx.fillRect(0, 0, width, height);

Â  Â  Â  Â  Â  Â  ctx.strokeStyle = '#eee';
Â  Â  Â  Â  Â  Â  ctx.lineWidth = 1;
Â  Â  Â  Â  Â  Â  ctx.beginPath();
Â  Â  Â  Â  Â  Â  ctx.moveTo(0, height / 2);
Â  Â  Â  Â  Â  Â  ctx.lineTo(width, height / 2);
Â  Â  Â  Â  Â  Â  ctx.stroke();

Â  Â  Â  Â  Â  Â  if (!timeDataArray && !snapshots.some(s=>s.active)) return;

Â  Â  Â  Â  Â  Â  snapshots.forEach(snap => {
Â  Â  Â  Â  Â  Â  Â  Â  if (snap.active && snap.time) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  drawSingleWaveLine(ctx, snap.time, width, height, snap.color, 2);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  if (analyser && rafId) {
Â  Â  Â  Â  Â  Â  Â  Â  drawSingleWaveLine(ctx, timeDataArray, width, height, '#222', 2);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function drawSingleWaveLine(ctx, data, width, height, color, lineWidth) {
Â  Â  Â  Â  Â  Â  ctx.lineWidth = lineWidth;
Â  Â  Â  Â  Â  Â  ctx.strokeStyle = color;
Â  Â  Â  Â  Â  Â  ctx.beginPath();

Â  Â  Â  Â  Â  Â  const sliceWidth = width * 1.0 / data.length;
Â  Â  Â  Â  Â  Â  let x = 0;
Â  Â  Â  Â  Â  Â  const amplitudeScale = 0.8;Â 

Â  Â  Â  Â  Â  Â  for (let i = 0; i < data.length; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  const v = data[i];Â 
Â  Â  Â  Â  Â  Â  Â  Â  const normalized = (v - 128) / 128.0;
Â  Â  Â  Â  Â  Â  Â  Â  const y = (height / 2) - (normalized * (height / 2) * amplitudeScale);

Â  Â  Â  Â  Â  Â  Â  Â  if (i === 0) { ctx.moveTo(x, y); }Â 
Â  Â  Â  Â  Â  Â  Â  Â  else { ctx.lineTo(x, y); }
Â  Â  Â  Â  Â  Â  Â  Â  x += sliceWidth;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  ctx.stroke();
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- ãƒ”ãƒƒãƒæ¤œå‡º & éŸ³ç¨‹è¨ˆç®— ---
Â  Â  Â  Â  function detectPitch(data, sampleRate, binCount) {
Â  Â  Â  Â  Â  Â  let maxIndex = -1;
Â  Â  Â  Â  Â  Â  let maxValue = 0;
Â  Â  Â  Â  Â  Â  const maxCheckIndex = Math.floor(binCount * 0.2);Â 
Â  Â  Â  Â  Â  Â  for (let i = 0; i < maxCheckIndex; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  if (data[i] > maxValue && data[i] > 100) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  maxValue = data[i];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  maxIndex = i;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if (maxIndex !== -1) return maxIndex * (sampleRate / analyser.fftSize);Â 
Â  Â  Â  Â  Â  Â  return 0;Â 
Â  Â  Â  Â  }

Â  Â  Â  Â  function freqToNote(freq) {
Â  Â  Â  Â  Â  Â  if (freq === 0) return {intl: "---", jpn: "---", cent: "---"};
Â  Â  Â  Â  Â  Â  const n = Math.round(12 * Math.log2(freq / A4_FREQ)) + 49;Â 
Â  Â  Â  Â  Â  Â  const octave = Math.floor(n / 12) - 1;
Â  Â  Â  Â  Â  Â  const noteIndex = (n % 12 + 12) % 12;Â 
Â  Â  Â  Â  Â  Â  return {
Â  Â  Â  Â  Â  Â  Â  Â  intl: NOTE_NAMES_INTL[noteIndex] + octave,Â 
Â  Â  Â  Â  Â  Â  Â  Â  jpn: NOTE_NAMES_JAPANESE[noteIndex] + octave,Â 
Â  Â  Â  Â  Â  Â  Â  Â  cent: `${Math.floor(1200 * Math.log2(freq / (A4_FREQ * Math.pow(HALF_STEP, n - 49))))} cent`
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  }

Â  Â  Â  Â  function displayResult(freq) {
Â  Â  Â  Â  Â  Â  const noteData = freqToNote(freq);
Â  Â  Â  Â  Â  Â  const freqStr = freq > 0 ? `${freq.toFixed(2)}` : "---";
Â  Â  Â  Â  Â  Â  // ã‚¹ãƒãƒ›å‘ã‘ã«çŸ­ãè¡¨ç¤º
Â  Â  Â  Â  Â  Â  resultDiv.innerHTML = `${freqStr} Hz / ${noteData.jpn} (${noteData.cent})`;
Â  Â  Â  Â  }
Â  Â  </script>
</body>
</html>
