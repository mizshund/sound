<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éŸ³ã®å‘¨æ³¢æ•°ãƒ»æ³¢å½¢ã‚¢ãƒŠãƒ©ã‚¤ã‚¶ (é…ç½®æ”¹å–„ç‰ˆ)</title>
    <style>
        /* --- åŸºæœ¬è¨­å®š --- */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; 
            text-align: center; 
            color: #333; 
            margin: 0;
            padding: 10px;
            background-color: #f4f4f4;
        }

        h1 { font-size: 1.2rem; margin: 5px 0; }
        p { font-size: 0.8rem; color: #666; margin-bottom: 10px; }

        /* --- ãƒ¡ã‚¤ãƒ³æ“ä½œãƒ‘ãƒãƒ« (é–‹å§‹/åœæ­¢) --- */
        .main-controls { 
            background-color: #fff;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 15px;
            display: inline-block;
        }

        /* --- ãƒœã‚¿ãƒ³å…±é€šã‚¹ã‚¿ã‚¤ãƒ« --- */
        button {
            padding: 8px 16px;
            font-size: 0.9rem;
            cursor: pointer;
            margin: 4px;
            border: 1px solid #ccc;
            border-radius: 6px;
            background-color: #fff;
            touch-action: manipulation;
            font-weight: bold;
            transition: transform 0.1s, background-color 0.2s;
        }
        button:active { transform: scale(0.95); }
        button:disabled { color: #ccc; border-color: #eee; background-color: #fafafa; }

        #startButton { background-color: #e3f2fd; border-color: #2196f3; color: #0d47a1; }
        #stopButton { background-color: #ffebee; border-color: #ef5350; color: #c62828; }
        #clearAllBtn { font-size: 0.8rem; }

        /* --- ã‚°ãƒ©ãƒ•ã”ã¨ã®ãƒ­ãƒ¼ã‚«ãƒ«æ“ä½œãƒãƒ¼ --- */
        .local-controls {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin-bottom: 5px;
            background: #f9f9f9;
            padding: 5px;
            border-radius: 6px;
        }

        .local-controls button {
            flex: 1; /* æ¨ªå¹…ã„ã£ã±ã„ã« */
            margin: 0 2px;
            font-size: 0.85rem;
            padding: 8px 0;
        }

        /* ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆãƒœã‚¿ãƒ³ (è‰²åˆ†ã‘) */
        .btn-snap-1 { border-color: #ef9a9a; color: #d32f2f; }
        .btn-snap-1.active { background-color: #d32f2f; color: white; }
        
        .btn-snap-2 { border-color: #90caf9; color: #1976d2; }
        .btn-snap-2.active { background-color: #1976d2; color: white; }
        
        .btn-snap-3 { border-color: #ffcc80; color: #f57c00; }
        .btn-snap-3.active { background-color: #f57c00; color: white; }

        /* --- çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ --- */
        #result { 
            margin: 0 auto 15px; 
            padding: 10px;
            background: #fff;
            display: table;
            border-radius: 8px;
            font-size: 1rem; 
            font-weight: bold; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        /* --- ã‚°ãƒ©ãƒ•ã‚³ãƒ³ãƒ†ãƒŠ --- */
        .graph-container { 
            display: flex; 
            flex-wrap: wrap; 
            justify-content: center; 
            gap: 20px; 
            width: 100%;
        }

        .graph-box {
            flex: 1 1 500px; /* PCã§ã¯æ¨ªä¸¦ã³ã€ã‚¹ãƒãƒ›ã§ã¯ç¸¦ç©ã¿ */
            max-width: 100%;
            background: #fff;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            box-sizing: border-box;
        }

        h2 { font-size: 0.95rem; margin: 0 0 8px; color: #555; border-bottom: 2px solid #eee; padding-bottom: 5px; }

        canvas {
            width: 100%;
            height: auto;
            display: block;
            border: 1px solid #eee;
            background-color: #fafafa;
        }
    </style>
</head>
<body>
    <h1>ğŸ¤ éŸ³ã®æ³¢å½¢ãƒ»å‘¨æ³¢æ•°ã‚¢ãƒŠãƒ©ã‚¤ã‚¶</h1>
    
    <div class="main-controls">
        <button id="startButton">â–¶ é–‹å§‹</button>
        <button id="stopButton" disabled>â–  åœæ­¢</button>
        <button id="clearAllBtn" disabled>å…¨ã‚¯ãƒªã‚¢</button>
    </div>

    <div id="result">
        å‘¨æ³¢æ•°: --- Hz / éŸ³ç¨‹: ---
    </div>

    <div class="graph-container">
        
        <div class="graph-box">
            <h2>1. æ™‚é–“æ³¢å½¢ (ã‚ªã‚·ãƒ­ã‚¹ã‚³ãƒ¼ãƒ—)</h2>
            <div class="local-controls">
                <button class="snap-btn btn-snap-1" data-id="0" disabled>â‘  èµ¤</button>
                <button class="snap-btn btn-snap-2" data-id="1" disabled>â‘¡ é’</button>
                <button class="snap-btn btn-snap-3" data-id="2" disabled>â‘¢ æ©™</button>
            </div>
            <canvas id="timeGraph"></canvas>
        </div>
        
        <div class="graph-box">
            <h2>2. å‘¨æ³¢æ•°ã‚¹ãƒšã‚¯ãƒˆãƒ« (FFT)</h2>
            <div class="local-controls">
                <button class="snap-btn btn-snap-1" data-id="0" disabled>â‘  èµ¤</button>
                <button class="snap-btn btn-snap-2" data-id="1" disabled>â‘¡ é’</button>
                <button class="snap-btn btn-snap-3" data-id="2" disabled>â‘¢ æ©™</button>
            </div>
            <canvas id="freqGraph"></canvas>
        </div>

    </div>

    <script>
        // --- ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° ---
        let audioContext;
        let analyser;
        let source;
        let rafId; 
        
        let freqDataArray; 
        let timeDataArray; 
        let currentDetectedFreq = 0; 

        // ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆãƒ‡ãƒ¼ã‚¿
        const snapshots = [
            { freq: null, time: null, active: false, color: 'rgba(255, 0, 0, 0.8)' },
            { freq: null, time: null, active: false, color: 'rgba(0, 0, 255, 0.7)' },
            { freq: null, time: null, active: false, color: 'rgba(255, 140, 0, 0.8)' }
        ];

        // UIè¦ç´ 
        const canvasElems = {
            freq: document.getElementById('freqGraph'),
            time: document.getElementById('timeGraph')
        };
        const canvasCtxs = {
            freq: canvasElems.freq.getContext('2d'),
            time: canvasElems.time.getContext('2d')
        };
        const resultDiv = document.getElementById('result');
        
        const startButton = document.getElementById('startButton');
        const stopButton = document.getElementById('stopButton');
        const clearAllBtn = document.getElementById('clearAllBtn');
        
        // å…¨ã¦ã®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆãƒœã‚¿ãƒ³ã‚’å–å¾—
        const snapButtons = document.querySelectorAll('.snap-btn');

        // å®šæ•°
        const A4_FREQ = 440;
        const HALF_STEP = Math.pow(2, 1/12); 
        const NOTE_NAMES_INTL = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
        const NOTE_NAMES_JAPANESE = ["ãƒ‰", "ãƒ‰#", "ãƒ¬", "ãƒ¬#", "ãƒŸ", "ãƒ•ã‚¡", "ãƒ•ã‚¡#", "ã‚½", "ã‚½#", "ãƒ©", "ãƒ©#", "ã‚·"];
        const MIN_FREQ_DISPLAY = 20; 
        const MAX_FREQ_DISPLAY = 8000; 
        const TICK_FREQS = [20, 50, 100, 200, 400, 800, 1600, 3200, 6400];

        // --- åˆæœŸåŒ– ---
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        startButton.onclick = startAnalysis;
        stopButton.onclick = stopAnalysis;
        clearAllBtn.onclick = clearAllSnapshots;

        // å„ãƒœã‚¿ãƒ³ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
        snapButtons.forEach(btn => {
            btn.onclick = () => {
                const index = parseInt(btn.getAttribute('data-id'));
                toggleSnapshot(index);
            };
        });

        // --- Canvasãƒªã‚µã‚¤ã‚ºå‡¦ç† ---
        function resizeCanvas() {
            const boxes = document.querySelectorAll('.graph-box');
            if (boxes.length === 0) return;
            
            const boxWidth = boxes[0].clientWidth;
            // æ¯”ç‡è¨­å®š
            const isMobile = window.innerWidth < 600;
            const newWidth = boxWidth - 20; 
            const newHeight = isMobile ? newWidth * 0.6 : newWidth * 0.45;

            const finalWidth = Math.max(newWidth, 300);
            const finalHeight = Math.max(newHeight, 180);

            for (let key in canvasElems) {
                canvasElems[key].width = finalWidth;
                canvasElems[key].height = finalHeight;
            }

            if (!rafId && (snapshots.some(s => s.active) || freqDataArray)) {
                requestAnimationFrame(() => {
                    drawFrequencyGraph();
                    drawTimeDomainGraph();
                });
            }
        }

        // --- è§£æé–‹å§‹ ---
        async function startAnalysis() {
            try {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (!audioContext) audioContext = new AudioContext();
                if (audioContext.state === 'suspended') await audioContext.resume();

                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: false,
                        noiseSuppression: false,
                        autoGainControl: false 
                    } 
                });

                analyser = audioContext.createAnalyser();
                source = audioContext.createMediaStreamSource(stream);
                
                analyser.fftSize = 2048; 
                analyser.smoothingTimeConstant = 0.85; 

                timeDataArray = new Uint8Array(analyser.fftSize); 
                freqDataArray = new Uint8Array(analyser.frequencyBinCount); 
                
                source.connect(analyser);

                // ãƒœã‚¿ãƒ³åˆ¶å¾¡
                startButton.disabled = true;
                stopButton.disabled = false;
                clearAllBtn.disabled = false;
                snapButtons.forEach(btn => btn.disabled = false);
                
                draw();

            } catch (err) {
                console.error(err);
                alert('ãƒã‚¤ã‚¯ã®ã‚¢ã‚¯ã‚»ã‚¹ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            }
        }

        // --- è§£æåœæ­¢ ---
        function stopAnalysis() {
            cancelAnimationFrame(rafId);
            rafId = null;
            if (source) {
                source.disconnect();
                source = null;
            }
            if (audioContext) audioContext.suspend();
            
            startButton.disabled = false;
            stopButton.disabled = true;
            clearAllBtn.disabled = true;
            snapButtons.forEach(btn => btn.disabled = true);
            
            currentDetectedFreq = 0; 
            resultDiv.innerHTML = "å‘¨æ³¢æ•°: --- Hz / éŸ³ç¨‹: ---";
        }

        // --- ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆå‡¦ç† ---
        function toggleSnapshot(index) {
            const snap = snapshots[index];
            
            // è©²å½“ã™ã‚‹IDã‚’æŒã¤å…¨ã¦ã®ãƒœã‚¿ãƒ³ã‚’å–å¾— (æ™‚é–“æ³¢å½¢ç”¨ã¨FFTç”¨ã®2ã¤ã‚ã‚‹)
            const targetButtons = document.querySelectorAll(`.snap-btn[data-id="${index}"]`);

            if (!snap.active) {
                if (freqDataArray && timeDataArray) {
                    snap.freq = new Uint8Array(freqDataArray);
                    snap.time = new Uint8Array(timeDataArray);
                    snap.active = true;
                    
                    // UIæ›´æ–° (å…¨ã¦ã®é–¢é€£ãƒœã‚¿ãƒ³)
                    targetButtons.forEach(btn => {
                        btn.classList.add('active');
                        btn.textContent = `â‘ â‘¡â‘¢`[index] + " æ¶ˆå»";
                    });
                }
            } else {
                snap.freq = null;
                snap.time = null;
                snap.active = false;
                
                targetButtons.forEach(btn => {
                    btn.classList.remove('active');
                    btn.textContent = `â‘ â‘¡â‘¢`[index] + ` ${['èµ¤','é’','æ©™'][index]}`;
                });
            }
        }

        function clearAllSnapshots() {
            snapshots.forEach((snap, index) => {
                snap.freq = null;
                snap.time = null;
                snap.active = false;
                
                const targetButtons = document.querySelectorAll(`.snap-btn[data-id="${index}"]`);
                targetButtons.forEach(btn => {
                    btn.classList.remove('active');
                    btn.textContent = `â‘ â‘¡â‘¢`[index] + ` ${['èµ¤','é’','æ©™'][index]}`;
                });
            });
        }

        // --- æç”»ãƒ«ãƒ¼ãƒ— ---
        function draw() {
            rafId = requestAnimationFrame(draw);

            if(analyser) {
                analyser.getByteFrequencyData(freqDataArray); 
                analyser.getByteTimeDomainData(timeDataArray); 
                currentDetectedFreq = detectPitch(freqDataArray, audioContext.sampleRate, analyser.frequencyBinCount);
            }
            
            drawFrequencyGraph();
            drawTimeDomainGraph(); 
            
            displayResult(currentDetectedFreq);
        }

        function freqToX(freq, width) {
            const clampedFreq = Math.max(freq, MIN_FREQ_DISPLAY); 
            const logMin = Math.log10(MIN_FREQ_DISPLAY);
            const logMax = Math.log10(MAX_FREQ_DISPLAY);
            const logFreq = Math.log10(clampedFreq);
            return (logFreq - logMin) / (logMax - logMin) * width;
        }

        // --- 1. å‘¨æ³¢æ•°ã‚°ãƒ©ãƒ•æç”» ---
        function drawFrequencyGraph() {
            const ctx = canvasCtxs.freq;
            const width = canvasElems.freq.width;
            const height = canvasElems.freq.height;
            const sampleRate = audioContext ? audioContext.sampleRate : 44100;
            const fftSize = analyser ? analyser.fftSize : 2048;
            const freqResolution = sampleRate / fftSize;
            
            ctx.fillStyle = '#fafafa';
            ctx.fillRect(0, 0, width, height);

            ctx.strokeStyle = '#eee'; 
            ctx.fillStyle = '#999'; 
            ctx.font = '10px sans-serif';
            ctx.textAlign = 'center';
            ctx.lineWidth = 1;

            TICK_FREQS.forEach(f => {
                const x = freqToX(f, width);
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, height);
                ctx.stroke();
                if (x > 15 && x < width - 15) ctx.fillText(`${f}`, x, height - 5);
            });
            
            if (!freqDataArray && !snapshots.some(s=>s.active)) return;

            const binCount = analyser ? analyser.frequencyBinCount : 1024;
            const startIndex = Math.floor(MIN_FREQ_DISPLAY / freqResolution); 
            const maxBinToDisplay = Math.min(binCount, Math.ceil(MAX_FREQ_DISPLAY / freqResolution));

            snapshots.forEach(snap => {
                if (snap.active && snap.freq) {
                    drawSingleFreqLine(ctx, snap.freq, width, height, freqResolution, startIndex, maxBinToDisplay, snap.color, 2);
                }
            });

            if (analyser && rafId) {
                drawSingleFreqLine(ctx, freqDataArray, width, height, freqResolution, startIndex, maxBinToDisplay, '#222', 2);
                
                if (currentDetectedFreq > MIN_FREQ_DISPLAY && currentDetectedFreq < MAX_FREQ_DISPLAY) {
                    const detectedX = freqToX(currentDetectedFreq, width);
                    const detectedIndex = Math.round(currentDetectedFreq / freqResolution);
                    let detectedY = height;
                    if(detectedIndex < freqDataArray.length) {
                        detectedY = height - (freqDataArray[detectedIndex] / 255 * height);
                    }
                    ctx.fillStyle = 'red';
                    ctx.beginPath();
                    ctx.arc(detectedX, detectedY, 6, 0, Math.PI * 2, false); 
                    ctx.fill();
                }
            }
        }

        function drawSingleFreqLine(ctx, data, width, height, resolution, startIndex, maxIndex, color, lineWidth) {
            ctx.lineWidth = lineWidth;
            ctx.strokeStyle = color;
            ctx.beginPath();
            let hasStarted = false;
            for (let i = startIndex; i < maxIndex; i++) {
                const x = freqToX(i * resolution, width);
                const y = height - (data[i] / 255 * height);
                if (!hasStarted) { ctx.moveTo(x, y); hasStarted = true; } 
                else { ctx.lineTo(x, y); }
            }
            ctx.stroke();
        }

        // --- 2. æ™‚é–“æ³¢å½¢ã‚°ãƒ©ãƒ•æç”» ---
        function drawTimeDomainGraph() {
            const ctx = canvasCtxs.time;
            const width = canvasElems.time.width;
            const height = canvasElems.time.height;

            ctx.fillStyle = '#fafafa';
            ctx.fillRect(0, 0, width, height);

            ctx.strokeStyle = '#eee';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(0, height / 2);
            ctx.lineTo(width, height / 2);
            ctx.stroke();

            if (!timeDataArray && !snapshots.some(s=>s.active)) return;

            snapshots.forEach(snap => {
                if (snap.active && snap.time) {
                    drawSingleWaveLine(ctx, snap.time, width, height, snap.color, 2);
                }
            });

            if (analyser && rafId) {
                drawSingleWaveLine(ctx, timeDataArray, width, height, '#222', 2);
            }
        }

        function drawSingleWaveLine(ctx, data, width, height, color, lineWidth) {
            ctx.lineWidth = lineWidth;
            ctx.strokeStyle = color;
            ctx.beginPath();

            const sliceWidth = width * 1.0 / data.length;
            let x = 0;
            const amplitudeScale = 0.8; 

            for (let i = 0; i < data.length; i++) {
                const v = data[i]; 
                const normalized = (v - 128) / 128.0;
                const y = (height / 2) - (normalized * (height / 2) * amplitudeScale);

                if (i === 0) { ctx.moveTo(x, y); } 
                else { ctx.lineTo(x, y); }
                x += sliceWidth;
            }
            ctx.stroke();
        }

        // --- ãƒ”ãƒƒãƒæ¤œå‡º & éŸ³ç¨‹è¨ˆç®— ---
        function detectPitch(data, sampleRate, binCount) {
            let maxIndex = -1;
            let maxValue = 0;
            const maxCheckIndex = Math.floor(binCount * 0.2); 
            for (let i = 0; i < maxCheckIndex; i++) {
                if (data[i] > maxValue && data[i] > 100) { 
                    maxValue = data[i];
                    maxIndex = i;
                }
            }
            if (maxIndex !== -1) return maxIndex * (sampleRate / analyser.fftSize); 
            return 0; 
        }

        function freqToNote(freq) {
            if (freq === 0) return {intl: "---", jpn: "---", cent: "---"};
            const n = Math.round(12 * Math.log2(freq / A4_FREQ)) + 49; 
            const octave = Math.floor(n / 12) - 1;
            const noteIndex = (n % 12 + 12) % 12; 
            return {
                intl: NOTE_NAMES_INTL[noteIndex] + octave, 
                jpn: NOTE_NAMES_JAPANESE[noteIndex] + octave, 
                cent: `${Math.floor(1200 * Math.log2(freq / (A4_FREQ * Math.pow(HALF_STEP, n - 49))))} cent`
            };
        }

        function displayResult(freq) {
            const noteData = freqToNote(freq);
            const freqStr = freq > 0 ? `${freq.toFixed(2)}` : "---";
            resultDiv.innerHTML = `${freqStr} Hz / ${noteData.jpn} (${noteData.cent})`;
        }
    </script>
</body>
</html>
